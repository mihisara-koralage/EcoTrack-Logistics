<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTrack - OpenStreetMap Demo</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- EcoTrack CSS -->
    <link rel="stylesheet" href="/css/driver-dashboard.css">
    
    <style>
        .map-container {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .map-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        .control-button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        .control-button:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        .control-button.secondary {
            background: #3498db;
        }
        .control-button.secondary:hover {
            background: #2980b9;
        }
        .route-visualization {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .route-point {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        .pickup-point {
            background: #e3f2fd;
            color: #1e40af;
        }
        .delivery-point {
            background: #f0f9ff;
            color: #1e40af;
        }
        .tracking-point {
            background: #fff3e0;
            color: #f59e0b;
        }
        .route-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .info-value {
            font-size: 24px;
            font-weight: bold;
            color: #27ae60;
        }
        .info-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <header style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #27ae60; margin-bottom: 10px;">üó∫Ô∏è EcoTrack OpenStreetMap Demo</h1>
            <p style="color: #666;">Realistic Sri Lankan parcel routes with accurate highway simulation</p>
        </header>

        <div id="statusMessage" class="status-message">Ready to initialize map...</div>

        <div class="map-controls">
            <button class="control-button" onclick="initializeMap()">
                üó∫Ô∏è Initialize Map
            </button>
            <button class="control-button" onclick="addRouteMarkers()">
                üìç Add Route Markers
            </button>
            <button class="control-button" onclick="calculateRoute()">
                üöÄ Calculate Route
            </button>
            <button class="control-button" onclick="simulateTracking()">
                üìç Simulate Tracking
            </button>
            <button class="control-button secondary" onclick="trackExistingParcel()">
                üì¶ Track Existing Parcel
            </button>
            <button class="control-button secondary" onclick="resetMap()">
                üîÑ Reset Map
            </button>
            <button class="control-button" onclick="goToParcelManager()" style="background: #e74c3c;">
                üì¶ Manage Parcels
            </button>
        </div>

        <div id="mapContainer" class="map-container">
            Loading map components...
        </div>

        <div id="routeVisualization" class="route-visualization" style="display: none;">
            <h3>üõ£Ô∏è Route Information</h3>
            <div id="routePoints"></div>
            
            <div class="route-info" id="routeInfo" style="display: none;">
                <div class="info-card">
                    <div class="info-value" id="routeDistance">0</div>
                    <div class="info-label">Distance (km)</div>
                </div>
                <div class="info-card">
                    <div class="info-value" id="routeDuration">0</div>
                    <div class="info-label">Duration (min)</div>
                </div>
                <div class="info-card">
                    <div class="info-value" id="routeProvider">-</div>
                    <div class="info-label">Route Provider</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map = null;
        let pickupMarker = null;
        let deliveryMarker = null;
        let currentLocationMarker = null;
        let routeLine = null;
        let trackingInterval = null;
        let currentRouteIndex = 0;

        // Sri Lankan sample routes with realistic data
        const sampleRoutes = [
            {
                id: 'PKG-2024-001',
                pickup: { lat: 6.9271, lng: 79.8612, name: 'Colombo Distribution Center' },
                delivery: { lat: 7.2906, lng: 80.6337, name: 'Kandy Delivery Point' },
                recipientName: 'Ranjan Perera',
                recipientPhone: '+94-77-123-4567',
                driver: 'John Silva',
                status: 'PickedUp'
            },
            {
                id: 'PKG-2024-002',
                pickup: { lat: 6.0535, lng: 80.2200, name: 'Galle Distribution Center' },
                delivery: { lat: 9.6615, lng: 80.0255, name: 'Jaffna Delivery Point' },
                recipientName: 'Nalini Fernando',
                recipientPhone: '+94-71-987-6543',
                driver: 'Kamal Perera',
                status: 'InTransit'
            }
        ];

        // Show status function
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.innerHTML = message;
            statusEl.className = `status-message ${isError ? 'error' : 'success'}`;
        }

        // Initialize map - make globally accessible
        window.initializeMap = function() {
            try {
                console.log('initializeMap called');
                showStatus('Initializing OpenStreetMap with Leaflet.js...', false);
                
                if (typeof L === 'undefined') {
                    console.error('Leaflet.js library is not loaded');
                    showStatus('Error: Leaflet.js library is not loaded', true);
                    return;
                }

                // Clear container
                document.getElementById('mapContainer').innerHTML = '';
                
                // Create map centered on Sri Lanka
                map = L.map('mapContainer').setView([7.8731, 80.7718], 8);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                showStatus('OpenStreetMap initialized successfully!', false);
                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Error initializing map:', error);
                showStatus('Error initializing map: ' + error.message, true);
            }
        }

        // Add route markers - make globally accessible
        window.addRouteMarkers = function() {
            if (!map) {
                showStatus('Please initialize map first', true);
                return;
            }

            try {
                const route = sampleRoutes[currentRouteIndex];
                
                // Clear existing markers
                if (pickupMarker) map.removeLayer(pickupMarker);
                if (deliveryMarker) map.removeLayer(deliveryMarker);
                if (currentLocationMarker) map.removeLayer(currentLocationMarker);
                if (routeLine) map.removeLayer(routeLine);

                // Add pickup marker
                pickupMarker = L.marker([route.pickup.lat, route.pickup.lng])
                    .addTo(map)
                    .bindPopup(`
                        <div style="padding: 10px;">
                            <strong>üìç Pickup Location</strong><br>
                            ${route.pickup.name}<br>
                            <small>Parcel: ${route.id}</small>
                        </div>
                    `);

                // Add delivery marker
                deliveryMarker = L.marker([route.delivery.lat, route.delivery.lng])
                    .addTo(map)
                    .bindPopup(`
                        <div style="padding: 10px;">
                            <strong>üéØ Delivery Location</strong><br>
                            ${route.delivery.name}<br>
                            <small>Recipient: ${route.recipientName}</small>
                        </div>
                    `);

                // Fit map to show both markers
                const group = new L.featureGroup([pickupMarker, deliveryMarker]);
                map.fitBounds(group.getBounds().pad(0.1));

                // Update route visualization
                document.getElementById('routeVisualization').style.display = 'block';
                document.getElementById('routePoints').innerHTML = `
                    <div class="route-point pickup-point">üìç ${route.pickup.name}</div>
                    <div class="route-point delivery-point">üéØ ${route.delivery.name}</div>
                `;

                showStatus('Route markers added successfully!', false);
                currentRouteIndex = (currentRouteIndex + 1) % sampleRoutes.length;
            } catch (error) {
                console.error('Error adding markers:', error);
                showStatus('Error adding markers: ' + error.message, true);
            }
        }

        // Calculate realistic route
        function calculateRoute() {
            if (!map || !pickupMarker || !deliveryMarker) {
                showStatus('Please add route markers first', true);
                return;
            }

            try {
                showStatus('Calculating realistic Sri Lankan route...', false);
                
                const route = sampleRoutes[currentRouteIndex - 1] || sampleRoutes[0];
                
                // Create realistic route using Sri Lankan highway network
                const latlngs = createRealisticRoute(route.pickup, route.delivery);
                
                // Clear existing route
                if (routeLine) map.removeLayer(routeLine);

                // Draw route polyline with enhanced styling
                routeLine = L.polyline(latlngs, {
                    color: '#27ae60',
                    weight: 4,
                    opacity: 0.7,
                    smoothFactor: 2,
                    dashArray: latlngs.length > 2 ? '10, 5' : null
                }).addTo(map);

                // Add waypoint markers for realistic route
                if (latlngs.length > 2) {
                    latlngs.forEach((point, index) => {
                        if (index > 0 && index < latlngs.length - 1) {
                            let locationName = '';
                            let coordinates = '';
                            
                            // Identify waypoint by coordinates
                            if (Math.abs(point[0] - 6.981) < 0.001 && Math.abs(point[1] - 79.991) < 0.001) {
                                locationName = 'Kadawatha Miriswatta (Near major junction/turnoff)';
                                coordinates = '6.981¬∞ N, 79.991¬∞ E';
                            } else if (Math.abs(point[0] - 7.052) < 0.001 && Math.abs(point[1] - 80.083) < 0.001) {
                                locationName = 'Pasyala (Central area)';
                                coordinates = '7.052¬∞ N, 80.083¬∞ E';
                            } else if (Math.abs(point[0] - 7.160) < 0.001 && Math.abs(point[1] - 80.190) < 0.001) {
                                locationName = 'Warakapola (Town center)';
                                coordinates = '7.160¬∞ N, 80.190¬∞ E';
                            } else if (Math.abs(point[0] - 7.261) < 0.001 && Math.abs(point[1] - 80.353) < 0.001) {
                                locationName = 'Kegalle (District Secretariat/Town)';
                                coordinates = '7.261¬∞ N, 80.353¬∞ E';
                            } else if (Math.abs(point[0] - 7.248) < 0.001 && Math.abs(point[1] - 80.447) < 0.001) {
                                locationName = 'Mawanella (Central point)';
                                coordinates = '7.248¬∞ N, 80.447¬∞ E';
                            } else if (Math.abs(point[0] - 7.270) < 0.001 && Math.abs(point[1] - 80.670) < 0.001) {
                                locationName = 'Pilimathalawa (Town center)';
                                coordinates = '7.270¬∞ N, 80.670¬∞ E';
                            } else if (Math.abs(point[0] - 6.5642) < 0.001 && Math.abs(point[1] - 79.9556) < 0.001) {
                                locationName = 'Panadura (Coastal town)';
                                coordinates = '6.5642¬∞ N, 79.9556¬∞ E';
                            } else if (Math.abs(point[0] - 7.4818) < 0.001 && Math.abs(point[1] - 80.3647) < 0.001) {
                                locationName = 'Kurunegala (Central junction)';
                                coordinates = '7.4818¬∞ N, 80.3647¬∞ E';
                            } else if (Math.abs(point[0] - 8.3454) < 0.001 && Math.abs(point[1] - 80.4037) < 0.001) {
                                locationName = 'Vavuniya (Northern junction)';
                                coordinates = '8.3454¬∞ N, 80.4037¬∞ E';
                            }
                            
                            const waypointMarker = L.circleMarker(point, {
                                radius: 4,
                                fillColor: '#e74c3c',
                                color: '#fff',
                                weight: 2,
                                opacity: 0.9
                            }).addTo(map)
                            .bindPopup(`
                                <div style="padding: 8px;">
                                    <strong>üõ£Ô∏è A1 Highway Checkpoint ${index}</strong><br>
                                    <strong>${locationName}</strong><br>
                                    <small>Coordinates: ${coordinates}</small><br>
                                    <small>Colombo-Kandy express route</small>
                                </div>
                            `);
                        }
                    });
                }

                // Calculate distance
                const distance = calculateRouteDistance(latlngs);
                const time = distance / 0.5; // Assume 50 km/h average speed

                // Update UI
                document.getElementById('routeInfo').style.display = 'grid';
                document.getElementById('routeDistance').textContent = distance.toFixed(1);
                document.getElementById('routeDuration').textContent = Math.round(time);
                document.getElementById('routeProvider').textContent = 'Sri Lankan Highway Network';

                showStatus('Realistic route calculated successfully!', false);
            } catch (error) {
                showStatus('Error calculating route: ' + error.message, true);
            }
        }

        // Create realistic Sri Lankan route
        function createRealisticRoute(pickup, delivery) {
            // Sri Lankan major highway network with accurate coordinates
            const sriLankanHighways = {
                'A1': [
                    [6.9271, 79.8612], // Colombo
                    [6.981, 79.991], // Kadawatha Miriswatta (Near the major junction/turnoff)
                    [7.052, 80.083], // Pasyala (Central area)
                    [7.160, 80.190], // Warakapola (Town center)
                    [7.261, 80.353], // Kegalle (District Secretariat/Town)
                    [7.248, 80.447], // Mawanella (Central point)
                    [7.270, 80.670], // Pilimathalawa (Town center)
                    [7.2906, 80.6337]  // Kandy
                ],
                'A2': [
                    [6.0535, 80.2200], // Galle
                    [6.5642, 79.9556], // Panadura (Coastal town)
                    [6.9271, 79.8612], // Colombo (Major hub)
                    [7.4818, 80.3647], // Kurunegala (Central junction)
                    [8.3454, 80.4037], // Vavuniya (Northern junction)
                    [9.6615, 80.0255]  // Jaffna
                ],
                'A6': [
                    [7.2906, 80.6337], // Kandy
                    [7.4818, 80.3647], // Kurunegala
                    [7.6730, 80.0958], // Near Galgamuwa
                    [8.3454, 80.4037], // Near Vavuniya
                    [9.6615, 80.0255]  // Jaffna
                ]
            };

            const waypoints = [];
            waypoints.push([pickup.lat, pickup.lng]);

            // Determine best highway route based on start/end points
            const isColomboToKandy = (
                (pickup.lat >= 6.90 && pickup.lat <= 6.95) && 
                (pickup.lng >= 79.85 && pickup.lng <= 79.88) &&
                (delivery.lat >= 7.28 && delivery.lat <= 7.30) && 
                (delivery.lng >= 80.60 && delivery.lng <= 80.65)
            );
            
            const isGalleToJaffna = (
                (pickup.lat >= 6.05 && pickup.lat <= 6.06) && 
                (pickup.lng >= 80.21 && pickup.lng <= 80.23) &&
                (delivery.lat >= 9.66 && delivery.lat <= 9.67) && 
                (delivery.lng >= 80.02 && delivery.lng <= 80.03)
            );

            if (isColomboToKandy) {
                // Use A1 highway for Colombo-Kandy
                waypoints.push(...sriLankanHighways.A1.slice(1));
                console.log('Using A1 highway for Colombo-Kandy route');
            } else if (isGalleToJaffna) {
                // Use A2 highway for Galle-Jaffna via Colombo
                waypoints.push(...sriLankanHighways.A2.slice(1));
                console.log('Using A2 highway for Galle-Jaffna route via Colombo');
            }
            else {
                // Default realistic curved route with more waypoints
                const latDiff = delivery.lat - pickup.lat;
                const lngDiff = delivery.lng - pickup.lng;
                const steps = 8; // More steps for smoother curves
                
                for (let i = 1; i <= steps; i++) {
                    const progress = i / (steps + 1);
                    
                    // Enhanced curves for realistic road patterns
                    const curve1 = Math.sin(progress * Math.PI * 2) * 0.025;
                    const curve2 = Math.cos(progress * Math.PI * 1.8) * 0.02;
                    const curve3 = Math.sin(progress * Math.PI * 3) * 0.015;
                    
                    const lat = pickup.lat + (latDiff * progress) + (curve1 * latDiff) + (curve2 * 0.8) + (curve3 * 0.5);
                    const lng = pickup.lng + (lngDiff * progress) + (curve1 * lngDiff) + (curve2 * 0.6) + (curve3 * 0.4);
                    
                    waypoints.push([lat, lng]);
                }
            }

            waypoints.push([delivery.lat, delivery.lng]);
            console.log(`Generated ${waypoints.length} waypoints for route`);
            return waypoints;
        }

        // Calculate route distance
        function calculateRouteDistance(latlngs) {
            let totalDistance = 0;
            for (let i = 0; i < latlngs.length - 1; i++) {
                const lat1 = latlngs[i][0];
                const lng1 = latlngs[i][1];
                const lat2 = latlngs[i + 1][0];
                const lng2 = latlngs[i + 1][1];
                
                // Haversine formula
                const R = 6371; // Earth's radius in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                totalDistance += R * c;
            }
            return totalDistance;
        }

        // Track existing parcel
        function trackExistingParcel() {
            if (!map) {
                showStatus('Please initialize map first', true);
                return;
            }

            try {
                // Check if there's a specific parcel ID to track
                const trackingParcelId = localStorage.getItem('tracking_parcel_id') || 'PKG-2024-002'; // Default to PKG-2024-002
                let parcelToTrack;
                
                if (trackingParcelId) {
                    // Find specific parcel by ID
                    parcelToTrack = sampleRoutes.find(p => p.id === trackingParcelId);
                    if (!parcelToTrack) {
                        showStatus(`Parcel ${trackingParcelId} not found. Using default parcel.`, true);
                        parcelToTrack = sampleRoutes.find(p => p.id === 'PKG-2024-002');
                    }
                    showStatus(`üì¶ Tracking ${trackingParcelId} with realistic Sri Lankan route...`, false);
                } else {
                    // Default to current route index
                    parcelToTrack = sampleRoutes[currentRouteIndex - 1] || sampleRoutes[0];
                    showStatus(`üì¶ Tracking ${parcelToTrack.id} with realistic Sri Lankan route...`, false);
                }
                
                // Clear existing markers and routes
                if (pickupMarker) map.removeLayer(pickupMarker);
                if (deliveryMarker) map.removeLayer(deliveryMarker);
                if (currentLocationMarker) map.removeLayer(currentLocationMarker);
                if (routeLine) map.removeLayer(routeLine);

                const parcel = parcelToTrack; // Use to tracked parcel

                // Add pickup marker
                pickupMarker = L.marker([parcel.pickup.lat, parcel.pickup.lng])
                    .addTo(map)
                    .bindPopup(`
                        <div style="padding: 10px; min-width: 200px;">
                            <strong>üì¶ Parcel ${parcel.id}</strong><br>
                            <strong>Status:</strong> <span style="color: #27ae60;">${parcel.status}</span><br>
                            <strong>Pickup:</strong> ${parcel.pickup.name}<br>
                            <strong>Delivery:</strong> ${parcel.delivery.name}<br>
                            <strong>Recipient:</strong> ${parcel.recipientName}<br>
                            <strong>Phone:</strong> ${parcel.recipientPhone}
                        </div>
                    `);

                // Add delivery marker
                deliveryMarker = L.marker([parcel.delivery.lat, parcel.delivery.lng])
                    .addTo(map)
                    .bindPopup(`
                        <div style="padding: 10px;">
                            <strong>üéØ Destination</strong><br>
                            <strong>Location:</strong> ${parcel.delivery.name}<br>
                            <strong>Coordinates:</strong> ${parcel.delivery.lat.toFixed(4)}, ${parcel.delivery.lng.toFixed(4)}<br>
                            <strong>Recipient:</strong> ${parcel.recipientName}<br>
                            <strong>Phone:</strong> ${parcel.recipientPhone}
                        </div>
                    `);

                // Create realistic route
                const routeWaypoints = createRealisticRoute(parcel.pickup, parcel.delivery);
                
                // Draw route line
                routeLine = L.polyline(routeWaypoints, {
                    color: '#27ae60',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 5'
                }).addTo(map);

                // Fit map to show entire route
                const bounds = L.latLngBounds([parcel.pickup, parcel.delivery]);
                map.fitBounds(bounds, { padding: [50, 50] });

                // Show route visualization
                document.getElementById('routeVisualization').style.display = 'block';
                document.getElementById('routeInfo').style.display = 'block';

                // Update route information
                document.getElementById('routeVisualization').innerHTML = `
                    <h3>üì¶ Parcel Tracking: ${parcel.id}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <h4>üìç Route Information</h4>
                            <p><strong>Pickup:</strong> ${parcel.pickup.name}</p>
                            <p><strong>Delivery:</strong> ${parcel.delivery.name}</p>
                            <p><strong>Distance:</strong> ${calculateRouteDistance(routeWaypoints).toFixed(1)} km</p>
                            <p><strong>Status:</strong> <span style="color: #27ae60;">${parcel.status}</span></p>
                        </div>
                        <div>
                            <h4>üë§ Recipient Information</h4>
                            <p><strong>Name:</strong> ${parcel.recipientName}</p>
                            <p><strong>Phone:</strong> ${parcel.recipientPhone}</p>
                            <p><strong>Driver:</strong> ${parcel.driver}</p>
                            <p><strong>Priority:</strong> ${parcel.priority || 'Standard'}</p>
                        </div>
                    </div>
                `;

                // Start automatic tracking simulation
                setTimeout(() => {
                    simulateTrackingForParcel(parcel);
                }, 1000);

            } catch (error) {
                console.error('Error tracking parcel:', error);
                showStatus('Error tracking parcel. Please try again.', true);
            }
        }

        // Simulate tracking for specific parcel
        function simulateTrackingForParcel(parcel) {
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }

            showStatus('üöö Starting realistic GPS tracking simulation...', false);
            
            const routeWaypoints = createRealisticRoute(parcel.pickup, parcel.delivery);
            let progress = 0;
            
            trackingInterval = setInterval(() => {
                progress += 1; // Move 1% each interval for smoother movement
                
                if (progress > 100) {
                    progress = 0; // Loop back to start
                }
                
                // Calculate position along realistic route waypoints
                const totalSegments = routeWaypoints.length - 1;
                const currentSegment = Math.floor((progress / 100) * totalSegments);
                const segmentProgress = ((progress / 100) * totalSegments) % 1;
                
                if (currentSegment < totalSegments) {
                    const startPoint = routeWaypoints[currentSegment];
                    const endPoint = routeWaypoints[currentSegment + 1];
                    
                    // Interpolate position between waypoints
                    const lat = startPoint[0] + (endPoint[0] - startPoint[0]) * segmentProgress;
                    const lng = startPoint[1] + (endPoint[1] - startPoint[1]) * segmentProgress;
                    
                    if (currentLocationMarker) {
                        currentLocationMarker.setLatLng([lat, lng]);
                    } else {
                        currentLocationMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'custom-div-icon',
                                html: '<div style="background: #e74c3c; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px;">üöö</div>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            })
                        }).addTo(map);
                    }
                    
                    // Update status with current location info
                    const segmentName = currentSegment === 0 ? 'A1 Highway (Colombo-Kadawatha)' : 
                                       currentSegment === 1 ? 'A1 Highway (Kadawatha-Pasyala)' :
                                       currentSegment === 2 ? 'A1 Highway (Pasyala-Warakapola)' :
                                       currentSegment === 3 ? 'A1 Highway (Warakapola-Kegalle)' :
                                       currentSegment === 4 ? 'A1 Highway (Kegalle-Mawanella)' :
                                       currentSegment === 5 ? 'A1 Highway (Mawanella-Pilimathalawa)' :
                                       currentSegment === 6 ? 'A1 Highway (Pilimathalawa-Kandy)' :
                                       currentSegment === 0 && parcel.pickup.lat >= 6.05 ? 'A2 Highway (Galle-Panadura)' :
                                       currentSegment === 1 && parcel.pickup.lat >= 6.05 ? 'A2 Highway (Panadura-Colombo)' :
                                       currentSegment === 2 && parcel.pickup.lat >= 6.05 ? 'A2 Highway (Colombo-Kurunegala)' :
                                       currentSegment === 3 && parcel.pickup.lat >= 6.05 ? 'A2 Highway (Kurunegala-Vavuniya)' :
                                       currentSegment === 4 && parcel.pickup.lat >= 6.05 ? 'A2 Highway (Vavuniya-Jaffna)' :
                                       `Route Segment ${currentSegment + 1}`;
                    
                    showStatus(`üöö Vehicle on ${segmentName} - ${Math.round(progress)}% complete`, false);
                }
            }, 200); // Update every 200ms for smooth animation
            
            showStatus('üìç GPS tracking active - vehicle following realistic highway route', false);
        }

        // Simulate tracking with realistic route following
        function simulateTracking() {
            if (!routeLine) {
                showStatus('Please calculate a route first', true);
                return;
            }

            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
                showStatus('GPS tracking stopped', false);
                return;
            }

            showStatus('Starting realistic GPS tracking simulation...', false);
            
            const route = sampleRoutes[currentRouteIndex - 1] || sampleRoutes[0];
            const routeWaypoints = createRealisticRoute(route.pickup, route.delivery);
            let progress = 0;
            
            trackingInterval = setInterval(() => {
                progress += 1; // Move 1% each interval for smoother movement
                
                if (progress > 100) {
                    progress = 0; // Loop back to start
                }
                
                // Calculate position along realistic route waypoints
                const totalSegments = routeWaypoints.length - 1;
                const currentSegment = Math.floor((progress / 100) * totalSegments);
                const segmentProgress = ((progress / 100) * totalSegments) % 1;
                
                if (currentSegment < totalSegments) {
                    const startPoint = routeWaypoints[currentSegment];
                    const endPoint = routeWaypoints[currentSegment + 1];
                    
                    // Interpolate position between waypoints
                    const lat = startPoint[0] + (endPoint[0] - startPoint[0]) * segmentProgress;
                    const lng = startPoint[1] + (endPoint[1] - startPoint[1]) * segmentProgress;
                    
                    if (currentLocationMarker) {
                        currentLocationMarker.setLatLng([lat, lng]);
                    }
                    
                    // Update status with current location info
                    const segmentName = currentSegment === 0 ? 'A1 Highway (Colombo-Kadawatha Miriswatta)' : 
                                       currentSegment === 1 ? 'A1 Highway (Kadawatha Miriswatta-Pasyala)' :
                                       currentSegment === 2 ? 'A1 Highway (Pasyala-Warakapola)' :
                                       currentSegment === 3 ? 'A1 Highway (Warakapola-Kegalle)' :
                                       currentSegment === 4 ? 'A1 Highway (Kegalle-Mawanella)' :
                                       currentSegment === 5 ? 'A1 Highway (Mawanella-Pilimathalawa)' :
                                       currentSegment === 6 ? 'A1 Highway (Pilimathalawa-Kandy)' :
                                       currentSegment === 0 && route.pickup.lat >= 6.05 ? 'A2 Highway (Galle-Panadura)' :
                                       currentSegment === 1 && route.pickup.lat >= 6.05 ? 'A2 Highway (Panadura-Colombo)' :
                                       currentSegment === 2 && route.pickup.lat >= 6.05 ? 'A2 Highway (Colombo-Kurunegala)' :
                                       currentSegment === 3 && route.pickup.lat >= 6.05 ? 'A2 Highway (Kurunegala-Vavuniya)' :
                                       currentSegment === 4 && route.pickup.lat >= 6.05 ? 'A2 Highway (Vavuniya-Jaffna)' :
                                       `Route Segment ${currentSegment + 1}`;
                    
                    showStatus(`üöö Vehicle on ${segmentName} - ${Math.round(progress)}% complete`, false);
                }
            }, 200); // Update every 200ms for smooth animation
            
            showStatus('GPS tracking active - vehicle following realistic A1 highway route', false);
        }

        // Reset map
        function resetMap() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            if (map) {
                if (pickupMarker) map.removeLayer(pickupMarker);
                if (deliveryMarker) map.removeLayer(deliveryMarker);
                if (currentLocationMarker) map.removeLayer(currentLocationMarker);
                if (routeLine) map.removeLayer(routeLine);
            }
            
            pickupMarker = null;
            deliveryMarker = null;
            currentLocationMarker = null;
            routeLine = null;
            
            document.getElementById('routeVisualization').style.display = 'none';
            document.getElementById('routeInfo').style.display = 'none';
            
            showStatus('Map reset successfully', false);
        }

        // Go to parcel manager
        function goToParcelManager() {
            showStatus('Opening Parcel Manager...', false);
            setTimeout(() => {
                window.location.href = '/parcel-manager.html';
            }, 1000);
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('Page loaded, ready to initialize map');
            showStatus('Page loaded. Click "Initialize Map" to begin.', false);
            
            // Make functions globally accessible
            window.initializeMap = window.initializeMap;
            window.addRouteMarkers = window.addRouteMarkers;
            window.trackExistingParcel = window.trackExistingParcel;
            window.calculateRoute = window.calculateRoute || function() {
                console.log('calculateRoute called but not yet implemented');
            };
            window.simulateTracking = window.simulateTracking || function() {
                console.log('simulateTracking called but not yet implemented');
            };
            window.resetMap = window.resetMap || function() {
                console.log('resetMap called but not yet implemented');
            };
            window.goToParcelManager = window.goToParcelManager || function() {
                console.log('goToParcelManager called but not yet implemented');
            };
            console.log('All functions made globally accessible');
        });
    </script>
</body>
</html>
